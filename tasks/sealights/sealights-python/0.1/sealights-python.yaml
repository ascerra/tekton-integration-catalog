apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: sealights-python-instrumentation
  labels:
    konflux-ci/sealights: "true"
    konflux-ci/sealights-language: "python"
spec:
  results:
    - name: sealights-bsid
      type: string
      description: "A unique identifier generated for the current sealights build session."
    - name: sealights-build-name
      type: string
      description: "A unique build name generated using the commit SHA and current date to prevent conflicts during test reruns."
    - name: source-artifact
      description: The Trusted Artifact URI pointing to the artifact with the application source code.
      type: string
  params:
    - name: source-artifact
      description: The Trusted Artifact URI pointing to the artifact with the application source code.
      type: string
    - name: python-version
      type: string
      description: "The Python version to use with the 'ubi8/python' image, in the format (e.g., '311')."
    - name: sealights-secret
      type: string
      description: "The name of the Openshift secret containing Sealights credentials."
    - name: component
      type: string
      description: "The name of the Konflux component associated with the integration tests."
    - name: scm-provider
      type: string
      default: "github"
      description: "The source control management (SCM) provider used for the project, such as 'github', 'gitlab'."
    - name: packages-excluded
      type: array
      default: []
      description: "A list of paths to exclude from Sealights instrumentation during the code scan. Specify paths to prevent them from being analyzed (e.g., '/app/tests/*','/app/examples/*')."
    - name: repository-url
      type: string
      description: "The name or URL of the source code repository (e.g., 'github.com/org/repo')."
      default: ""
    - name: branch
      type: string
      description: "The name of the Git branch to use for the operation (e.g., 'main' or 'feature-branch')."
      default: "main"
    - name: revision
      type: string
      description: "The Git revision (commit SHA) from which the test pipeline is originating."
    - name: test-event
      type: string
      description: "Indicates if the job is triggered by a Pull Request or a Push event."
      default: ""
    - name: pull-request-number
      type: string
      description: "The identifier number of the pull request/merge request."
      default: ""
    - name: target-branch
      type: string
      description: "The name of the target branch for the pull request, typically the branch into which the changes will be merged (e.g., 'main', 'develop')."
      default: "main"
    - name: oci-storage
      description: The OCI repository where the Trusted Artifacts are stored.
      type: string
  volumes:
    - name: sealights-credentials
      secret:
        secretName: sealights-credentials
    - name: workdir
      emptyDir: {}
  stepTemplate:
    volumeMounts:
      - mountPath: /app
        name: workdir
      - name: sealights-credentials
        mountPath: /usr/local/sealights-credentials
  steps:
    - name: use-trusted-artifact
      image: quay.io/redhat-appstudio/build-trusted-artifacts:latest@sha256:52f1391e6f1c472fd10bb838f64fae2ed3320c636f536014978a5ddbdfc6b3af
      args:
        - use
        - $(params.source-artifact)=/app/source
    - name: sealights-python-instrumentation
      image: registry.access.redhat.com/ubi8/python-$(params.python-version):latest
      workingDir: /app/source
      securityContext:
        runAsUser: 0
      env:
        - name: COMPONENT
          value: $(params.component)
        - name: SCM_PROVIDER
          value: $(params.scm-provider)
        - name: REPOSITORY_URL
          value: $(params.repository-url)
        - name: BRANCH
          value: $(params.branch)
        - name: REVISION
          value: $(params.revision)
        - name: PULL_REQUEST_NUMBER
          value: $(params.pull-request-number)
        - name: TARGET_BRANCH
          value: $(params.target-branch)
        - name: TEST_EVENT
          value: $(params.test-event)
      args: ["$(params.packages-excluded[*])"] 
      script: |
        #!/bin/sh
        set -euo pipefail

        ls -lt
        pwd

        export SEALIGHTS_TOKEN BUILD_NAME BSID PACKAGES_EXCLUDED_ENUM

        SEALIGHTS_TOKEN="$(cat /usr/local/sealights-credentials/token)"
        BUILD_NAME="${REVISION}_$(date +'%y%m%d.%H%M')"
        PACKAGES_EXCLUDED_ENUM="$(IFS=,; echo "$(printf "%s," $@ | sed 's/,$//')")"

        pip install sealights-python-agent
        echo "exclude: ${PACKAGES_EXCLUDED_ENUM}"
        ls -la
        pwd
        sl-python config --appname "${COMPONENT}" --branchname "${TARGET_BRANCH}" --buildname "${BUILD_NAME}" --exclude "${PACKAGES_EXCLUDED_ENUM}" --workspacepath /app --token "${SEALIGHTS_TOKEN}"

        sl-python scan  --buildsessionidfile buildSessionId.txt --scm "${SCM_PROVIDER}" --token "${SEALIGHTS_TOKEN}"

        echo -n "$(cat buildSessionId.txt)" > $(results.sealights-bsid.path)
        echo -n "$BUILD_NAME" > $(results.sealights-build-name.path)
    - name: create-trusted-artifact
      image: quay.io/redhat-appstudio/build-trusted-artifacts:latest@sha256:52f1391e6f1c472fd10bb838f64fae2ed3320c636f536014978a5ddbdfc6b3af
      args:
        - create
        - --store
        - $(params.oci-storage)
        - $(results.source-artifact.path)=/app/source